<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="c:\Users\User\Downloads\‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ (3)-Photoroom.png">
    <link rel="stylesheet" href="tutorial_Kaorop.css">
    <title>‡∏ó‡πà‡∏≤‡πÄ‡∏Ñ‡∏≤‡∏£‡∏û</title>
    <style>
    </style>
</head>

<body>
    <h1>‡∏£‡∏î. ‡∏£‡∏≠‡πÄ‡∏î‡πâ‡∏≤</h1>
    <h6>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</h6>
    <h7>‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö:</h7>
    <h2>Score:</h2>
    <h3>Feedback:</h3>
    <h4 id="score">-</h4>
    <h5 id="feedback">-</h5>
    <h9 id="level">-</h9>

    <div class = "tap_under"></div>
    
    <div class="camera-permission" id="cameraPermission"></div>
    
    <div class="countdown" id="countdown" style="display:none;"></div>

    <canvas id="canvas" width="400" height="300" style="display:none;"></canvas>
    <video id="camera" autoplay playsinline></video>

    <audio id="startSound" src="c:\\Users\\User\\Downloads\\Wantayahat.mp3"></audio>

    <script>
const video = document.getElementById("camera");
const canvas = document.getElementById("canvas");
const countdownElement = document.getElementById('countdown');
const cameraPermissionElement = document.getElementById('cameraPermission');
const ctx = canvas.getContext("2d");
const startSound = document.getElementById('startSound');
let cameraStarted = false;
let sessionId = null;
let frameInterval = null;

async function startCamera() {
  try {
    cameraPermissionElement.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏¥...";
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
    cameraStarted = true;
    video.style.display = "block";

    startSound.play().catch(err => console.log("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ:", err));
    cameraPermissionElement.style.display = "none";
    startCountdown();

  } catch (error) {
    cameraPermissionElement.textContent = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: " + error.message;
  }
}

function startCountdown() {
  let count = 3;
  countdownElement.style.display = "block";
  countdownElement.textContent = count;

  const countdownInterval = setInterval(() => {
    count--;
    if (count > 0) {
      countdownElement.textContent = count;
    } else {
      countdownElement.textContent = "";
      countdownElement.style.display = "none";
      clearInterval(countdownInterval);
      startSession(); // ‡πÄ‡∏£‡∏¥‡πà‡∏° session ‡πÉ‡∏´‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô
    }
  }, 1000);
}

async function startSession() {
  try {
    const res = await fetch("http://127.0.0.1:8000/start_analysis", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({}),
    });
    const data = await res.json();
    if (data.session_id) {
      sessionId = data.session_id;
      console.log("üéØ ‡πÄ‡∏£‡∏¥‡πà‡∏° session:", sessionId);
      startSendingFrames();
    }
  } catch (err) {
    console.error("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏° session ‡πÑ‡∏î‡πâ:", err);
  }
}

function startSendingFrames() {
  frameInterval = setInterval(async function () {
    if (!cameraStarted || !sessionId) return;

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const image = canvas.toDataURL("image/jpeg");

    try {
      const res = await fetch("http://127.0.0.1:8000/analyze_pose", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ image, session_id: sessionId }),
      });
      const data = await res.json();

      if (data.status === "completed") {
        // ‚úÖ ‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏™‡∏£‡πá‡∏à
        clearInterval(frameInterval);
        console.log("‚úÖ ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô");

        document.getElementById("score").textContent = data.final_score + "%";
        document.getElementById("feedback").textContent = data.feedback;
        document.getElementById("level").textContent = data.level;
      } else if (data.status === "waiting") {
        // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ ‚Üí ‡πÑ‡∏°‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
        console.log("‚åõ ‡∏£‡∏≠‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤...");
      }

    } catch (err) {
      console.error("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
    }
  }, 1000);
}

startCamera();
    </script>
    
    <img class="logo" src="c:\Users\User\Downloads\‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ (3)-Photoroom.png" alt="logo" />
    <div class="tap_on"></div>
    <img class="bg" src="c:\Users\User\Downloads\‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ (1).jpg" alt="background" />
    <div class="white"></div>
    <div class="white2"></div>
    <div class="white3"></div>
    <a href="kaorop.html">
        <h11>Tutorial</h11>
    </a>

    <a href="tutorial_Kaorop.html">
        <h12>Training</h12>
    </a>

    <a href="index.html">
        <h10>Home</h10>
    </a>
</body>
</html>